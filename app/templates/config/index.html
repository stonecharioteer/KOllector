{% extends 'layout.html' %}
{% block title_suffix %} â€” Config{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 m-0">Config: Source Folders</h1>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('tasks.trigger_scan') }}">Scan All</a>
</div>

<form method="post" class="row g-2 mb-3" id="add-path-form">
  <div class="col-md-7">
    <input name="path" id="path-input" class="form-control" placeholder="/data/highlights/boox-palma" list="path-suggestions" autocomplete="off" required>
    <datalist id="path-suggestions"></datalist>
  </div>
  <div class="col-md-3">
    <input name="device_label" class="form-control" placeholder="Device label (e.g., boox-palma)">
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-primary">Add Folder</button>
  </div>
</form>

<table class="table table-sm align-middle">
  <thead>
    <tr><th>Path</th><th>Device Label</th><th>Enabled</th><th></th></tr>
  </thead>
  <tbody>
  {% for p in paths %}
    <tr>
      <td><code>{{ p.path }}</code></td>
      <td>
        <form method="post" action="{{ url_for('config.update_label', pid=p.id) }}" class="d-flex gap-2">
          <input name="device_label" class="form-control form-control-sm" value="{{ p.device_label or '' }}" placeholder="Label">
          <button class="btn btn-sm btn-outline-primary">Save</button>
        </form>
      </td>
      <td>{{ 'Yes' if p.enabled else 'No' }}</td>
      <td class="text-end">
        <form method="post" action="{{ url_for('config.toggle', pid=p.id) }}" class="d-inline">
          <button class="btn btn-sm btn-outline-secondary">{{ 'Disable' if p.enabled else 'Enable' }}</button>
        </form>
        <form method="post" action="{{ url_for('config.delete', pid=p.id) }}" class="d-inline ms-1" onsubmit="return confirm('Delete?')">
          <button class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
      </td>
    </tr>
  {% endfor %}
 </tbody>
</table>

<hr class="my-4">

<h2 class="h5">Periodic Scanning</h2>
<p class="text-muted small mb-2">Configure automatic highlight scanning using cron syntax. The default schedule is every 15 minutes (*/15 * * * *).</p>
<form method="post" class="row g-2 mb-3" id="scan-schedule-form">
  <div class="col-sm-6">
    <input name="scan_schedule" id="scan-schedule-input" class="form-control" placeholder="*/15 * * * *" value="{{ cfg.scan_schedule or '*/15 * * * *' }}" required>
    <small class="text-muted">Format: minute hour day month day_of_week</small>
  </div>
  <div class="col-sm-3 d-grid">
    <button class="btn btn-primary" id="save-schedule-btn">Save Schedule</button>
  </div>
  <div class="col-sm-3">
    <button type="button" class="btn btn-outline-secondary" id="validate-schedule-btn">Validate</button>
  </div>
  <div class="col-12">
    <div id="schedule-validation" class="mt-2"></div>
  </div>
</form>

<hr class="my-4">

<h2 class="h5">Open Library</h2>
<p class="text-muted small mb-2">Both fields are required to use Open Library features (search, metadata enrichment).</p>
<form method="post" class="row g-2 mb-3">
  <div class="col-sm-4">
    <input name="ol_app_name" class="form-control" placeholder="App Name (required)" value="{{ cfg.ol_app_name or '' }}" required>
  </div>
  <div class="col-sm-5">
    <input name="ol_contact_email" type="email" class="form-control" placeholder="Contact Email (required)" value="{{ cfg.ol_contact_email or '' }}" required>
  </div>
  <div class="col-sm-3 d-grid">
    <button class="btn btn-primary">Save Open Library Config</button>
  </div>
</form>

<h2 class="h5">Image Management</h2>
<div class="mb-4">
  <form method="post" action="{{ url_for('books.migrate_images_to_database') }}" class="d-inline" onsubmit="return confirm('This will migrate all external image URLs to database blobs. Continue?')">
    <button type="submit" class="btn btn-outline-secondary btn-sm">Migrate Images to Database</button>
  </form>
  <small class="text-muted ms-2">Converts existing external cover URLs to database-stored blobs.</small>
</div>

<script>
  (function(){
    const input = document.getElementById('path-input');
    const list = document.getElementById('path-suggestions');
    let timer;
    function updateSuggestions() {
      const q = input.value || '';
      fetch(`/config/suggest?prefix=${encodeURIComponent(q)}`)
        .then(r => r.ok ? r.json() : {paths: []})
        .then(data => {
          const opts = (data.paths || []).map(p => `<option value="${p}"></option>`).join('');
          list.innerHTML = opts;
        })
        .catch(() => { list.innerHTML = ''; });
    }
    input.addEventListener('input', function(){
      clearTimeout(timer);
      timer = setTimeout(updateSuggestions, 150);
    });
    // Initial suggestions for convenience
    updateSuggestions();
  })();

  // Cron validation
  (function(){
    const scheduleInput = document.getElementById('scan-schedule-input');
    const validateBtn = document.getElementById('validate-schedule-btn');
    const validationDiv = document.getElementById('schedule-validation');
    const form = document.getElementById('scan-schedule-form');

    function validateCronExpression() {
      const expression = scheduleInput.value.trim();
      if (!expression) {
        validationDiv.innerHTML = '<div class="alert alert-danger">Cron expression cannot be empty</div>';
        return;
      }

      validationDiv.innerHTML = '<div class="alert alert-info">Validating...</div>';

      fetch(`/config/validate-cron?expression=${encodeURIComponent(expression)}`)
        .then(r => r.json())
        .then(data => {
          if (data.valid) {
            const nextRuns = data.next_runs.map(t => `<li>${t}</li>`).join('');
            validationDiv.innerHTML = `
              <div class="alert alert-success">
                <strong>Valid cron expression!</strong>
                <p class="mb-1 mt-2">Next 3 scheduled runs:</p>
                <ul class="mb-0">${nextRuns}</ul>
              </div>
            `;
          } else {
            validationDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          }
        })
        .catch(err => {
          validationDiv.innerHTML = '<div class="alert alert-danger">Failed to validate cron expression</div>';
        });
    }

    validateBtn.addEventListener('click', validateCronExpression);

    // Validate on input change with debounce
    let validateTimer;
    scheduleInput.addEventListener('input', function(){
      clearTimeout(validateTimer);
      validateTimer = setTimeout(validateCronExpression, 500);
    });

    // Validate on form submit
    form.addEventListener('submit', function(e) {
      const expression = scheduleInput.value.trim();
      if (!expression) {
        e.preventDefault();
        validationDiv.innerHTML = '<div class="alert alert-danger">Cron expression cannot be empty</div>';
        return false;
      }
    });
  })();
  </script>
{% endblock %}
